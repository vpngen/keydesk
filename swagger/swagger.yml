---
swagger: '2.0'
info:
  version: 1.0.0
  title: Keydesk server
basePath: /
paths:
  /token:
    post:
      produces:
        - application/json
      responses:
        201:
          description: Token created.
          schema:
            $ref: "#/definitions/token"
        503:
          description: 'Maintenance'
          schema:
            $ref: "#/definitions/maintenance_error"
        500:
          description: 'Internal server error'
        default:
          description: error
          schema:
            $ref: "#/definitions/error"
  /user:
    get:
      security:
        - Bearer: [ ]
      produces:
        - application/json
      responses:
        200:
          description: A list of users.
          schema:
            type: array
            items:
              $ref: "#/definitions/user"
        403:
          description: 'You do not have necessary permissions for the resource'
        503:
          description: 'Maintenance'
          schema:
            $ref: "#/definitions/maintenance_error"
        500:
          description: 'Internal server error'
        default:
          description: error
          schema:
            $ref: "#/definitions/error"
    post:
      security:
        - Bearer: [ ]
      produces:
        - application/json
      responses:
        201:
          description: New user created.
          schema:
            $ref: "#/definitions/newuser"
        403:
          description: 'You do not have necessary permissions for the resource'
        503:
          description: 'Maintenance'
          schema:
            $ref: "#/definitions/maintenance_error"
        500:
          description: 'Internal server error'
        default:
          description: error
          schema:
            $ref: "#/definitions/error"

  /user/{UserID}:
    delete:
      security:
        - Bearer: [ ]
      produces:
        - application/json
      parameters:
        - type: string
          name: UserID
          in: path
          required: true
      responses:
        204:
          description: User deleted.
        403:
          description: 'You do not have necessary permissions for the resource'
        503:
          description: 'Maintenance'
          schema:
            $ref: "#/definitions/maintenance_error"
        500:
          description: 'Internal server error'
        default:
          description: error
          schema:
            $ref: "#/definitions/error"
  /users/stats:
    get:
      security:
        - Bearer: [ ]
      produces:
        - application/json
      responses:
        200:
          description: A list of stats.
          schema:
            $ref: "#/definitions/stats"
        403:
          description: 'You do not have necessary permissions for the resource'
        503:
          description: 'Maintenance'
          schema:
            $ref: "#/definitions/maintenance_error"
        500:
          description: 'Internal server error'
        default:
          description: error
          schema:
            $ref: "#/definitions/error"
  /messages:
    get:
      summary: Get messages
      description: Get messages, used by frontend. JWT token is required.
      operationId: getMessages
      security:
        - Bearer: [ ]
      parameters:
        - in: query
          name: offset
          type: integer
          default: 0
        - in: query
          name: limit
          type: integer
          default: 25
        - in: query
          name: read
          type: boolean
        - in: query
          name: priority
          type: integer
        - in: query
          name: sort-priority
          type: string
          enum:
            - asc
            - desc
        - in: query
          name: sort-time
          type: string
          enum:
            - asc
            - desc
        - in: query
          name: priority-op
          type: string
          default: eq
          enum:
            - eq
            - ne
            - gt
            - lt
            - ge
            - le
      responses:
        200:
          description: List of messages
          schema:
            $ref: '#/definitions/Messages'
        500:
          $ref: '#/definitions/error'
  /messages/{id}/read:
    post:
      summary: Mark message as read
      description: Used by frontend. JWT token is required.
      operationId: markMessageAsRead
      security:
        - Bearer: [ ]
      parameters:
        - in: path
          name: id
          type: string
          format: uuid
          required: true
      responses:
        200:
          description: OK
        default:
          description: error
          schema:
            $ref: "#/definitions/error"

definitions:
  token:
    type: object
    required:
      - Token
    properties:
      Token:
        type: string
  newuser:
    type: object
    required:
      - UserName
    properties:
      UserName:
        type: string
      WireguardConfig:
        type: object
        required:
          - TonnelName
          - FileName
          - FileContent
        properties:
          TonnelName:
            type: string
          FileName:
            type: string
          FileContent:
            type: string
      AmnzOvcConfig:
        type: object
        required:
          - TonnelName
          - FileName
          - FileContent
        properties:
          TonnelName:
            type: string
          FileName:
            type: string
          FileContent:
            type: string
      IPSecL2TPManualConfig:
        type: object
        required:
          - Server
          - PSK
          - Username
          - Password
        properties:
          Server:
            type: string
          PSK:
            type: string
          Username:
            type: string
          Password:
            type: string
      OutlineConfig:
        type: object
        required:
          - AccessKey
        properties:
          AccessKey:
            type: string
      VPNGenConfig:
        $ref: '#/definitions/VPNGenConfig'
  user:
    type: object
    required:
      - UserID
      - UserName
      - CreatedAt
      - Status
      - MonthlyQuotaRemainingGB
    properties:
      UserID:
        type: string
      UserName:
        type: string
      Status:
        type: string
      CreatedAt:
        type: string
        format: date-time
      ThrottlingTill:
        type: string
        format: date-time
        x-nullable: true
      MonthlyQuotaRemainingGB:
        type: number
        format: float
      LastVisitHour:
        type: string
        format: date-time
        x-nullable: true
      PersonName:
        type: string
      PersonDesc:
        type: string
      PersonDescLink:
        type: string
  stats:
    type: object
    required:
      - TotalUsers
      - ActiveUsers
      - TotalTrafficGB
    properties:
      TotalUsers:
        type: array
        items:
          type: object
          required:
            - Month
            - Value
          properties:
            Month:
              type: integer
            Value:
              type: integer
      ActiveUsers:
        type: array
        items:
          type: object
          required:
            - Month
            - Value
          properties:
            Month:
              type: integer
            Value:
              type: integer
      TotalTrafficGB:
        type: array
        items:
          type: object
          required:
            - Month
            - Value
          properties:
            Month:
              type: integer
            Value:
              type: number
              format: float
  error:
    type: object
    required:
      - message
    properties:
      code:
        type: integer
      message:
        type: string
  maintenance_error:
    type: object
    required:
      - code
      - message
      - retry_after
    properties:
      code:
        type: integer
      message:
        type: string
      retry_after:
        type: string
  Message:
    type: object
    properties:
      id:
        type: string
        format: uuid
      text:
        type: string
      title:
        type: string
      is_read:
        type: boolean
      priority:
        type: integer
      time:
        type: string
        format: date-time
      ttl:
        type: string
    required:
      - text
      - title
  Messages:
    type: object
    properties:
      messages:
        type: array
        items:
          $ref: '#/definitions/Message'
      total:
        type: integer
    required:
      - messages
      - total
  VPNGenConfig:
    type: object
    properties:
      config:
        $ref: '#/definitions/Meta'
      wireguard:
        $ref: '#/definitions/Wireguard'
      cloak:
        $ref: '#/definitions/Cloak'
      shadowsocks:
        $ref: '#/definitions/Shadowsocks'
  Meta:
    type: object
    properties:
      version:
        type: integer
        example: 1
      name:
        type: string
        example: "0_Yet_Another_Staging_JSON"
      extended:
        type: integer
        example: 1
    required:
      - version
      - name
      - extended
  Wireguard:
    type: object
    properties:
      Interface:
        $ref: '#/definitions/WireguardInterface'
      Peer:
        $ref: '#/definitions/WireguardPeer'
    required:
      - Interface
      - Peer
  WireguardInterface:
    type: object
    properties:
      PrivateKey:
        type: string
        format: byte
        example: "OGldQ4F+94FX2XAUfZb6hx30U3/aeZ8Xn6V07Egw/3M="
      Address:
        type: string
        example: "172.16.0.2,fd0d:86fa:c3bc::2"
      DNS:
        type: string
        example: "172.16.0.1,fd0d:86fa:c3bc::1"
    required:
      - PrivateKey
      - Address
      - DNS
  WireguardPeer:
    type: object
    properties:
      PublicKey:
        type: string
        format: byte
        example: "gLXvjRXiSv3HHeXbnRxBxLPMfXDesAnJ2mpJveabNjM="
      PresharedKey:
        format: byte
        example: null
      AllowedIPs:
        type: string
        example: "0.0.0.0/0,::/0"
      Endpoint:
        type: string
        example: "195.133.0.118:40000"
    required:
      - PublicKey
      - AllowedIPs
      - Endpoint
  Cloak:
    type: object
    properties:
      RemoteHost:
        type: string
        example: "195.133.0.115"
      RemotePort:
        type: integer
        example: 443
      UID:
        type: string
        example: "FLaIuM1TN4902FHHnzU/yQ=="
      PublicKey:
        type: string
        format: byte
        example: "oD/F2vU4oaAFeA5Rh43Qbn8G2QnlKQOdGe18YxiskRw="
      ProxyBook:
        $ref: '#/definitions/ProxyBook'
    required:
      - RemoteHost
      - RemotePort
      - UID
      - PublicKey
      - ProxyBook
  ProxyBook:
    type: object
    properties:
      shadowsocks:
        $ref: '#/definitions/Shadowsocks'
    required:
      - shadowsocks
  Shadowsocks:
    type: object
    properties:
      host:
        type: string
        example: "195.133.0.115"
      port:
        type: integer
        example: 9944
      cipher:
        type: string
        example: "AEAD_CHACHA20_POLY1305"
      password:
        type: string
        example: "Cc6bBZVzaSz9moET8K6wBNEVQ6gctF1ffQtqqmGy4dnF6LJLoXHNxvLrG2dW1yoeCjKSgkThZ5EAVQtcM9j3RAAnYssPVSxW"
    required:
    - cipher
    - password
securityDefinitions:
  Bearer:
    type: apiKey
    name: Authorization
    in: header
