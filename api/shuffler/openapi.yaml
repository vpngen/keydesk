openapi: 3.0.3
info:
  title: Shuffler message API
  description: Shuffler message API
  version: 1.0.0
paths:
  /configs:
    post:
      summary: Create new VPN config
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                configs:
                  type: array
                  items:
                    type: string
                domain:
                  type: string
                  description: Domain for connection, if omitted default domain is domain of keydesk
              required:
                - configs
              example:
                type: outline
                domain: example.com
      security:
        - JWTAuth: [ configs:create ]
      responses:
        201:
          description: New VPN config, unique ID is returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  configs:
                    $ref: '#/components/schemas/VPNConfig'
                  name:
                    type: string
                  domain:
                    type: string
                  free_slots:
                    type: integer
                    description: Number of free VPN slots after creation
                  total_slots:
                    type: integer
                    description: Total number of VPN slots
                required:
                  - id
                  - configs
                  - name
                  - domain
                  - free_slots
                  - total_slots
        412:
          description: No free VPN slots
        default:
          $ref: '#/components/responses/ErrorResponse'
  /configs/{id}:
    delete:
      summary: Delete VPN config
      parameters:
        - name: id
          schema:
            type: string
            format: uuid
          in: path
          required: true
      responses:
        200:
          description: Successfully deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  free_slots:
                    type: integer
                required:
                  - free_slots
        404:
          description: User not found
        default:
          $ref: '#/components/responses/ErrorResponse'
      security:
        - JWTAuth: [ configs:delete ]
  /configs/{id}/block:
    patch:
      summary: Block VPN config
      parameters:
        - name: id
          schema:
            type: string
            format: uuid
          in: path
          required: true
      responses:
        200:
          description: Successfully blocked
          content:
            application/json:
              schema:
                type: object
                properties:
                  free_slots:
                    type: integer
                required:
                  - free_slots
        404:
          description: User not found
        default:
          $ref: '#/components/responses/ErrorResponse'
      security:
        - JWTAuth: [ configs:delete ]
  /configs/{id}/unblock:
    patch:
      summary: Unlock VPN config
      parameters:
        - name: id
          schema:
            type: string
            format: uuid
          in: path
          required: true
      responses:
        200:
          description: Successfully unblocked
          content:
            application/json:
              schema:
                type: object
                properties:
                  free_slots:
                    type: integer
                required:
                  - free_slots
        404:
          description: User not found
        default:
          $ref: '#/components/responses/ErrorResponse'
      security:
        - JWTAuth: [ configs:delete ]
  /slots:
    get:
      summary: Get free VPN slots
      responses:
        200:
          description: Free VPN slots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlotsInfo'
        default:
          $ref: '#/components/responses/ErrorResponse'
      security:
        - JWTAuth: [ ]
  /activity:
    get:
      summary: Get VPN users activity
      responses:
        200:
          description: Last connection by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Activities'
        default:
          $ref: '#/components/responses/ErrorResponse'
      security:
        - JWTAuth: [ ]
components:
  schemas:
#    ConfigType:
#      type: string
#      description: VPN type
#      enum:
#        - outline
#        - ovc
#        - wg
#        - ipsec
    OutlineConfig:
      properties:
        access_key:
          type: string
      required:
        - access_key
    Proto0Config:
      properties:
        access_key:
          type: string
      required:
        - access_key
    AmneziaOVCConfig:
      properties:
        tunnel_name:
          type: string
        file_name:
          type: string
        file_content:
          type: string
      required:
        - tunnel_name
        - file_name
        - file_content
    IPSecL2TPConfig:
      type: object
      properties:
        username:
          type: string
        password:
          type: string
        server:
          type: string
        psk:
          type: string
      required:
        - username
        - password
        - server
        - psk
    WireGuardConfig:
      properties:
        tunnel_name:
          type: string
        file_name:
          type: string
        file_content:
          type: string
      required:
        - tunnel_name
        - file_name
        - file_content
    VPNConfig:
      type: object
      properties:
        wireguard:
          $ref: '#/components/schemas/WireGuardConfig'
        amnezia:
          $ref: '#/components/schemas/AmneziaOVCConfig'
        outline:
          type: string
        ipsec:
          $ref: '#/components/schemas/IPSecL2TPConfig'
        proto0:
          $ref: '#/components/schemas/Proto0Config'
        vgc:
          type: string
    SlotsInfo:
      type: object
      properties:
        free_slots:
          type: integer
        total_slots:
          type: integer
      required:
        - free_slots
        - total_slots
    Activity:
      type: object
      properties:
        last_seen:
          type: string
          format: date-time
        updated:
          type: string
          format: date-time
      required:
        - last_seen
        - updated
      x-go-type: user.Activity
      x-go-type-import:
        path: github.com/vpngen/keydesk/internal/user
    Activities:
      additionalProperties:
        $ref: '#/components/schemas/Activity'
      x-go-type: user.Activities
      x-go-type-import:
        path: github.com/vpngen/keydesk/internal/user

    Error:
      type: string
  responses:
    ErrorResponse:
      description: Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
  securitySchemes:
    JWTAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
